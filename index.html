<!-- Aleksey Bykhun -->
<!DOCTYPE html>
<html>
  <head>
    <title>Follow Head Demo - A-Frame</title>
    <meta name="description" content="Vaporwave aesthetic Asteroid Demo." />
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
    <!-- <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script> -->
    <!-- <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script> -->
    <script type="text/javascript">

    const EARTH_RADIUS = 4;
    const IS_SHOW_GRID = false;

    AFRAME.registerComponent('earth', {
      init: function () {
        window.earth = this.el;
        this.el.object3D.position.y = -EARTH_RADIUS;
        this.el.setAttribute('radius', EARTH_RADIUS);
      }
    });

    AFRAME.registerComponent('grid', {
      init: function () {
        if (!IS_SHOW_GRID)
          this.el.remove();
      }
    });

    AFRAME.registerComponent('head', {
      init: function () {
        window.head = this.el;
      }
    });

    const calculateRotation = (headPosition) => {
      const rotation = {};

      rotation.x = -headPosition.z / EARTH_RADIUS;
      rotation.z =  headPosition.x / EARTH_RADIUS;

      return rotation;
    }
    AFRAME.registerComponent('follow-head', {
      tick: function () {
        const { position } = window.head.object3D;

        this.el.object3D.position.x = position.x;
        this.el.object3D.position.z = position.z;

        const rotation = calculateRotation(position);

        this.el.object3D.rotation.x = rotation.x;
        this.el.object3D.rotation.z = rotation.z;
      }
    });

    AFRAME.registerComponent('follow-head-rotation', {
      tick: function () {
        const { position } = window.head.object3D;

        const rotation = calculateRotation(position);

        this.el.object3D.rotation.x = rotation.x;
        this.el.object3D.rotation.z = rotation.z;
      }
    });
    </script>
  </head>
  <body>
    <a-scene stats>
      <a-assets timeout="10000">
        <img
          src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png"
          id="grid"
          crossorigin="anonymous"
        />
        <img
          id="sky"
          src="https://cdn.glitch.com/03242f16-d041-41e4-a30f-c084435bc64e%2Fstars_texture2942.jpg?v=1607731920565"
          crossorigin="anonymous"
        />

        <img
          id="asteroid_texture"
          src="assets/asteroid_ceres/asteroid.png"
          crossorigin="anonymous"
        />

        <a-asset-item
          id="asteroid"
          src="assets/asteroid_ceres/asteroid.gltf"
          crossorigin="anonymous"
        ></a-asset-item>

        <a-asset-item
          id="asteroid2"
          src="assets/Bennu_1_1.gltf"
          crossorigin="anonymous"
        ></a-asset-item>

        <a-asset-item
          id="mega"
          src="assets/mega_scene/scene.gltf"
          crossorigin="anonymous"
        ></a-asset-item>

      </a-assets>

      <a-sphere
        material="src: #asteroid_texture; metalness: 0.6; roughness: 0.4; sphericalEnvMap: #asteroid_texture;"
        position="0 -1 0"
        radius="1"
        follow-head
        earth
      ></a-sphere>

      <!-- Grid -->
      <a-entity
        grid
        geometry="primitive: plane; width: 10000; height: 10000;"
        rotation="-90 0 0"
        material="src: #grid; repeat: 10000 10000; transparent: true;metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"
      ></a-entity>

      <a-entity
        light="color: #ccccff; intensity: 1; type: ambient;"
        visible=""
      ></a-entity>
      <a-entity
        light="color: #ffaaff; intensity: 1.5"
        position="5 5 5"
      ></a-entity>
      <a-entity
        light="color: white; intensity: 0.5"
        position="-5 5 15"
      ></a-entity>

      <a-entity light="color: white; type: ambient;"></a-entity>

      <a-sky
        src="#sky"
        follow-head-rotation
      ></a-sky>

      <a-entity oculus-touch-controls="hand: left"></a-entity>
      <a-entity oculus-touch-controls="hand: right"></a-entity>

      <a-entity id="rig" position="0 1.6 0">

        <a-entity id="camera" camera look-controls wasd-controls head></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
